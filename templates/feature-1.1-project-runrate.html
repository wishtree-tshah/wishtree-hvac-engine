<!-- ============================================ -->
<!-- FEATURE 1.1: PROJECT VS RUN-RATE SPLITTER -->
<!-- Location: Insert into #view-demand-ai div -->
<!-- ============================================ -->

<div class="dashboard-grid">
    <!-- Filter Controls -->
    <div class="glass-panel wide" style="grid-column: span 4;">
        <div class="panel-header">
            <h3><i class="fa-solid fa-chart-column"></i> Project vs Run-Rate Demand Analysis</h3>
            <div class="filter-controls">
                <select id="product-group-filter" class="filter-select">
                    <option value="condensers">Condensers</option>
                    <option value="airHandlers">Air Handlers</option>
                    <option value="compressors">Compressors</option>
                </select>
                <div class="toggle-group">
                    <button class="toggle-btn active" data-view="units">Units</button>
                    <button class="toggle-btn" data-view="revenue">Revenue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stacked Bar Chart -->
    <div class="chart-panel glass-panel" style="grid-column: span 3;">
        <div class="panel-header">
            <h3>Monthly Demand Breakdown</h3>
        </div>
        <div class="chart-container">
            <canvas id="projectRunRateChart"></canvas>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="glass-panel">
        <div class="panel-header">
            <h3>Current Month Summary</h3>
        </div>
        <div class="metric-stack">
            <div class="metric-item">
                <span class="metric-label">Total Units</span>
                <span class="metric-value" id="total-units">1,640</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Run-Rate</span>
                <span class="metric-value success" id="runrate-units">1,200 (73%)</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Project</span>
                <span class="metric-value warning" id="project-units">440 (27%)</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Volatility Risk</span>
                <span class="badge warning">Medium</span>
            </div>
        </div>
    </div>

    <!-- Recent Projects Table -->
    <div class="glass-panel wide" style="grid-column: span 4;">
        <div class="panel-header">
            <h3>Recent Large Projects</h3>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Project Name</th>
                    <th>Units</th>
                    <th>Value</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="recent-projects-body">
                <tr>
                    <td>Memorial Hospital HVAC Retrofit</td>
                    <td>320</td>
                    <td>$285K</td>
                    <td><span class="badge success">Completed</span></td>
                </tr>
                <tr>
                    <td>School District Summer Upgrade</td>
                    <td>180</td>
                    <td>$165K</td>
                    <td><span class="badge warning">In Progress</span></td>
                </tr>
                <tr>
                    <td>Office Complex New Construction</td>
                    <td>240</td>
                    <td>$220K</td>
                    <td><span class="badge">Quoted</span></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- CSS for this feature (add to style.css) -->
<style>
    .filter-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .filter-select {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--glass-border);
        color: var(--text-main);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .metric-stack {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 0;
    }

    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid var(--glass-border);
    }

    .metric-item:last-child {
        border-bottom: none;
    }

    .metric-label {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .metric-value {
        font-size: 1.1rem;
        font-weight: 600;
    }
</style>

<!-- JavaScript for this feature (add to app.js) -->
<script>
    // Initialize Project vs Run-Rate Chart
    function initProjectRunRateChart() {
        const ctx = document.getElementById('projectRunRateChart');
        if (!ctx) return;

        const data = EXTENDED_DATA.demandAI.projectVsRunRate;
        const productGroup = 'condensers'; // Default

        new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: 'Run-Rate Units',
                        data: data[productGroup].runRate,
                        backgroundColor: '#3b82f6',
                        stack: 'stack1'
                    },
                    {
                        label: 'Project Units',
                        data: data[productGroup].project,
                        backgroundColor: '#f59e0b',
                        stack: 'stack1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8' } },
                    tooltip: {
                        callbacks: {
                            footer: function (context) {
                                const total = context[0].parsed.y + (context[1]?.parsed.y || 0);
                                const projectPct = Math.round((context[1]?.parsed.y / total) * 100);
                                return `Total: ${total} units (${projectPct}% project)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        stacked: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#94a3b8' }
                    },
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    }
</script>